import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseService } from '@/lib/supabaseClient';
import { checkUserSubscription } from '@/utils/supabaseClient';
import { processWithMindee } from '@/app/api/upload-receipt/route';

interface WhatsAppMessage {
  From: string;
  To: string;
  Body?: string;
  MediaUrl0?: string;
  MediaContentType0?: string;
  NumMedia: string;
}

interface WhatsAppBusinessWebhook {
  object: string;
  entry: Array<{
    id: string;
    changes: Array<{
      value: {
        messaging_product: string;
        metadata: {
          display_phone_number: string;
          phone_number_id: string;
        };
        messages?: Array<{
          from: string;
          id: string;
          timestamp: string;
          text?: { body: string };
          image?: {
            mime_type: string;
            sha256: string;
            id: string;
          };
          type: string;
        }>;
      };
    }>;
  }>;
}

// Funci√≥n para limpiar n√∫mero de tel√©fono
function cleanPhoneNumber(phone: string): string {
  return phone.replace('whatsapp:', '').replace('+', '');
}

// Funci√≥n para obtener integraciones del usuario
async function getUserIntegrations(phoneNumber: string) {
  const supabase = getSupabaseService();
  
  // Intentar diferentes formatos del n√∫mero
  const phoneFormats = [
    phoneNumber, // Formato original
    phoneNumber.replace('whatsapp:', ''), // Quitar prefijo whatsapp:
    phoneNumber.replace('whatsapp:', '').replace('+', ''), // Quitar whatsapp: y +
    phoneNumber.replace('+', ''), // Solo quitar +
    phoneNumber.replace(/^34/, ''), // Quitar 34 del principio (ESTE ES EL IMPORTANTE)
    phoneNumber.replace(/^(\+34|34)/, ''), // Quitar +34 o 34 del principio
    `+34${phoneNumber}`, // A√±adir +34
    phoneNumber.replace('+34', ''), // Quitar +34
    `+${phoneNumber}`, // A√±adir +
    phoneNumber.replace('+', ''), // Quitar +
    phoneNumber.replace(/\D/g, '') // Solo n√∫meros
  ];

  console.log('üîç getUserIntegrations - Buscando con n√∫mero:', phoneNumber);
  console.log('üì± getUserIntegrations - Formatos a probar:', phoneFormats);

  let profile = null;
  let foundWithFormat = '';

  // Buscar el usuario con diferentes formatos
  for (const phoneFormat of phoneFormats) {
    console.log(`üîé getUserIntegrations - Probando formato: "${phoneFormat}"`);
    
    const { data, error } = await supabase
      .from('profiles')
      .select('id, empresa_id, telefono')
      .eq('telefono', phoneFormat)
      .single();

    if (!error && data) {
      profile = data;
      foundWithFormat = phoneFormat;
      console.log(`‚úÖ getUserIntegrations - Usuario encontrado con formato: "${phoneFormat}"`);
      break;
    } else {
      console.log(`‚ùå getUserIntegrations - No encontrado con formato: "${phoneFormat}"`);
    }
  }

  if (!profile) {
    console.log('‚ùå getUserIntegrations - Usuario no encontrado');
    return [];
  }

  const integrations = [];
  
  // Verificar Holded
  const { data: holded } = await supabase
    .from('holded_credentials')
    .select('*')
    .eq('empresa_id', profile.empresa_id)
    .single();
  
  if (holded) {
    integrations.push({
      type: 'holded',
      name: 'Holded',
      icon: 'üü¢'
    });
  }

  // Verificar Odoo
  const { data: odoo } = await supabase
    .from('odoo_credentials')
    .select('*')
    .eq('empresa_id', profile.empresa_id)
    .single();
  
  if (odoo) {
    integrations.push({
      type: 'odoo',
      name: 'Odoo',
      icon: 'üü£'
    });
  }

  // Verificar Xero
  const { data: xero } = await supabase
    .from('xero_credentials')
    .select('*')
    .eq('empresa_id', profile.empresa_id)
    .single();
  
  if (xero) {
    integrations.push({
      type: 'xero',
      name: 'Xero',
      icon: 'üîµ'
    });
  }

  return integrations;
}

// Funci√≥n para generar men√∫ de integraciones
function generateIntegrationsMenu(integrations: any[], phoneNumber: string) {
  if (integrations.length === 0) {
    return {
      message: `‚ùå *No tienes integraciones configuradas*\n\nVe a tu dashboard para configurar Odoo, Holded o Xero.`,
      hasIntegrations: false
    };
  }

  let message = `‚úÖ *Factura procesada correctamente*\n\nüîó *Selecciona d√≥nde enviar la factura:*\n\n`;
  
  integrations.forEach((integration, index) => {
    const numero = index + 1;
    message += `${numero}. ${integration.icon} ${integration.name}\n`;
  });

  message += `\nüí¨ *Responde con el n√∫mero de tu elecci√≥n*`;

  return {
    message,
    hasIntegrations: true,
    integrations
  };
}

// Funci√≥n para enviar mensaje de WhatsApp
async function sendWhatsAppMessage(phoneNumber: string, message: string) {
  const isTwilio = process.env.TWILIO_ACCOUNT_SID && process.env.TWILIO_AUTH_TOKEN;
  const isWhatsAppBusiness = process.env.WHATSAPP_BUSINESS_TOKEN;

  if (isTwilio) {
    // Usar Twilio (para testing)
    const response = await fetch(
      `https://api.twilio.com/2010-04-01/Accounts/${process.env.TWILIO_ACCOUNT_SID}/Messages.json`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Authorization': `Basic ${Buffer.from(`${process.env.TWILIO_ACCOUNT_SID}:${process.env.TWILIO_AUTH_TOKEN}`).toString('base64')}`
        },
        body: new URLSearchParams({
          From: process.env.TWILIO_WHATSAPP_NUMBER!,
          To: `whatsapp:+${phoneNumber}`,
          Body: message
        })
      }
    );
    return response.json();
  } else if (isWhatsAppBusiness) {
    // Usar WhatsApp Business API (para producci√≥n)
    const response = await fetch(
      `https://graph.facebook.com/v18.0/${process.env.WHATSAPP_BUSINESS_PHONE_NUMBER_ID}/messages`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${process.env.WHATSAPP_BUSINESS_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          messaging_product: 'whatsapp',
          to: phoneNumber,
          type: 'text',
          text: {
            body: message
          }
        })
      }
    );
    return response.json();
  }

  throw new Error('No WhatsApp service configured');
}

// Funci√≥n para descargar archivo multimedia
async function downloadMedia(mediaUrl: string): Promise<Buffer> {
  console.log('‚¨áÔ∏è Descargando archivo multimedia desde:', mediaUrl);
  
  // Usar autenticaci√≥n b√°sica para Twilio
  const authString = Buffer.from(`${process.env.TWILIO_ACCOUNT_SID}:${process.env.TWILIO_AUTH_TOKEN}`).toString('base64');
  
  const response = await fetch(mediaUrl, {
    headers: {
      'Authorization': `Basic ${authString}`
    }
  });
  
  console.log('üì• Respuesta de descarga:', response.status, response.statusText);
  
  if (!response.ok) {
    console.log('‚ùå Error descargando archivo:', response.status, response.statusText);
    throw new Error(`Failed to download media: ${response.statusText}`);
  }
  
  const arrayBuffer = await response.arrayBuffer();
  const buffer = Buffer.from(arrayBuffer);
  console.log('‚úÖ Archivo descargado exitosamente, tama√±o:', buffer.length, 'bytes');
  
  return buffer;
}

// Funci√≥n para procesar recibo
async function processReceipt(phoneNumber: string, mediaBuffer: Buffer, mediaType: string) {
  try {
    // Crear un File object desde el buffer
    const file = new File([mediaBuffer], 'receipt.jpg', { type: mediaType });
    
    // Llamar directamente a la funci√≥n de procesamiento de Mindee
    console.log('üß† Llamando a Mindee API...');
    const mindeeResult = await processWithMindee(file);
    console.log('üìä Resultado de Mindee:', mindeeResult);
    
    if (!mindeeResult.success) {
      console.log('‚ùå Error de Mindee:', mindeeResult.error);
      throw new Error(mindeeResult.error || 'Error procesando factura');
    }
    
    console.log('‚úÖ Mindee proces√≥ exitosamente');
    
    // Obtener el usuario por n√∫mero de tel√©fono
    const supabase = getSupabaseService();
    
      // Intentar diferentes formatos del n√∫mero
  const phoneFormats = [
    phoneNumber, // Formato original
    phoneNumber.replace('whatsapp:', ''), // Quitar prefijo whatsapp:
    phoneNumber.replace('whatsapp:', '').replace('+', ''), // Quitar whatsapp: y +
    phoneNumber.replace('+', ''), // Solo quitar +
    phoneNumber.replace(/^34/, ''), // Quitar 34 del principio (ESTE ES EL IMPORTANTE)
    phoneNumber.replace(/^(\+34|34)/, ''), // Quitar +34 o 34 del principio
    `+34${phoneNumber}`, // A√±adir +34
    phoneNumber.replace('+34', ''), // Quitar +34
    `+${phoneNumber}`, // A√±adir +
    phoneNumber.replace('+', ''), // Quitar +
    phoneNumber.replace(/\D/g, '') // Solo n√∫meros
  ];

    console.log('üîç processReceipt - Buscando con n√∫mero:', phoneNumber);
    console.log('üì± processReceipt - Formatos a probar:', phoneFormats);

    let profile = null;
    let foundWithFormat = '';

    // Buscar el usuario con diferentes formatos
    for (const phoneFormat of phoneFormats) {
      console.log(`üîé processReceipt - Probando formato: "${phoneFormat}"`);
      
      const { data, error } = await supabase
        .from('profiles')
        .select('id, empresa_id, telefono')
        .eq('telefono', phoneFormat)
        .single();

      if (!error && data) {
        profile = data;
        foundWithFormat = phoneFormat;
        console.log(`‚úÖ processReceipt - Usuario encontrado con formato: "${phoneFormat}"`);
        break;
      } else {
        console.log(`‚ùå processReceipt - No encontrado con formato: "${phoneFormat}"`);
      }
    }
    
    if (!profile) {
      console.log('‚ùå processReceipt - Usuario no encontrado');
      throw new Error('Usuario no encontrado');
    }
    
    // Guardar el recibo en la base de datos
    console.log('üíæ Guardando recibo en base de datos...');
    const { data: receipt, error } = await supabase
      .from('receipts')
      .insert({
        user_id: profile.id,
        empresa_id: profile.empresa_id,
        fecha_emision: mindeeResult.data.date || new Date().toISOString().split('T')[0],
        proveedor: mindeeResult.data.supplier_name || 'Desconocido',
        numero_factura: mindeeResult.data.invoice_number || null,
        total: mindeeResult.data.total_amount || 0,
        moneda: mindeeResult.data.currency || 'EUR',
        estado: 'procesado',
        file_name: 'whatsapp_receipt.jpg',
        file_type: 'image/jpeg',
        status: 'completed',
        metadatos: mindeeResult.data,
        created_at: new Date().toISOString()
      })
      .select()
      .single();
    
    if (error) {
      console.log('‚ùå Error guardando recibo:', error);
      throw new Error(`Error guardando recibo: ${error.message}`);
    }
    
    console.log('‚úÖ Recibo guardado exitosamente con ID:', receipt.id);
    
    return {
      success: true,
      receiptId: receipt.id,
      data: mindeeResult.data
    };
    
  } catch (error) {
    throw error;
  }
}

// Funci√≥n processWithMindee importada desde upload-receipt

// Funci√≥n para manejar comandos de texto
async function handleTextCommand(phoneNumber: string, command: string) {
  const cleanPhone = cleanPhoneNumber(phoneNumber);
  
  switch (command.toLowerCase()) {
    case 'menu':
    case 'men√∫':
      const integrations = await getUserIntegrations(cleanPhone);
      const menu = generateIntegrationsMenu(integrations, cleanPhone);
      await sendWhatsAppMessage(cleanPhone, menu.message);
      break;
    
    case 'ayuda':
    case 'help':
      const helpMessage = `ü§ñ *Comandos disponibles:*\n\n` +
        `üì∑ *Env√≠a una imagen* - Procesar factura\n` +
        `üìã *menu* - Ver integraciones\n` +
        `‚ùì *ayuda* - Ver este mensaje\n` +
        `üìä *estado* - Ver tu plan actual`;
      await sendWhatsAppMessage(cleanPhone, helpMessage);
      break;
    
    case 'estado':
      const userStatus = await checkUserSubscription(cleanPhone);
      const statusMessage = userStatus.isSubscribed
        ? `‚úÖ *Plan activo*\n\nüìä Facturas restantes: ${userStatus.remainingQuota}`
        : `‚ùå *Plan inactivo*\n\nVe a tu dashboard para activar tu suscripci√≥n.`;
      await sendWhatsAppMessage(cleanPhone, statusMessage);
      break;
    
    default:
      // Verificar si es una selecci√≥n num√©rica para integraciones
      const selection = parseInt(command);
      if (!isNaN(selection) && selection > 0) {
        const integrations = await getUserIntegrations(cleanPhone);
        if (selection <= integrations.length) {
          const selectedIntegration = integrations[selection - 1];
          await sendWhatsAppMessage(cleanPhone, 
            `üîÑ *Enviando a ${selectedIntegration.name}...*\n\n` +
            `Tu factura ser√° procesada en ${selectedIntegration.name}.`
          );
          
          // Obtener el recibo m√°s reciente del usuario
          const supabase = getSupabaseService();
          
          // Intentar diferentes formatos del n√∫mero
          const phoneFormats = [
            cleanPhone, // Formato original
            cleanPhone.replace('whatsapp:', ''), // Quitar prefijo whatsapp:
            cleanPhone.replace('whatsapp:', '').replace('+', ''), // Quitar whatsapp: y +
            cleanPhone.replace('+', ''), // Solo quitar +
            cleanPhone.replace(/^34/, ''), // Quitar 34 del principio (ESTE ES EL IMPORTANTE)
            cleanPhone.replace(/^(\+34|34)/, ''), // Quitar +34 o 34 del principio
            `+34${cleanPhone}`, // A√±adir +34
            cleanPhone.replace('+34', ''), // Quitar +34
            `+${cleanPhone}`, // A√±adir +
            cleanPhone.replace('+', ''), // Quitar +
            cleanPhone.replace(/\D/g, '') // Solo n√∫meros
          ];

          console.log('üîç handleTextCommand - Buscando con n√∫mero:', cleanPhone);
          console.log('üì± handleTextCommand - Formatos a probar:', phoneFormats);

          let userProfile = null;
          let foundWithFormat = '';

          // Buscar el usuario con diferentes formatos
          for (const phoneFormat of phoneFormats) {
            console.log(`üîé handleTextCommand - Probando formato: "${phoneFormat}"`);
            
            const { data, error } = await supabase
              .from('profiles')
              .select('id, telefono')
              .eq('telefono', phoneFormat)
              .single();

            if (!error && data) {
              userProfile = data;
              foundWithFormat = phoneFormat;
              console.log(`‚úÖ handleTextCommand - Usuario encontrado con formato: "${phoneFormat}"`);
              break;
            } else {
              console.log(`‚ùå handleTextCommand - No encontrado con formato: "${phoneFormat}"`);
            }
          }
          
          if (!userProfile) {
            await sendWhatsAppMessage(cleanPhone, 
              `‚ùå *Usuario no encontrado*\n\nNo se pudo encontrar tu perfil.`
            );
            return;
          }
          
          const { data: recentReceipt } = await supabase
            .from('receipts')
            .select('*')
            .eq('user_id', userProfile.id)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();
          
          if (recentReceipt) {
            // Enviar a la integraci√≥n espec√≠fica
            try {
              const integrationResponse = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || 'https://tu-dominio.vercel.app'}/api/whatsapp/send-to-integration`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  phoneNumber: cleanPhone,
                  receiptId: recentReceipt.id,
                  integrationType: selectedIntegration.type,
                  receiptData: recentReceipt.processed_data
                })
              });
              
              if (integrationResponse.ok) {
                await sendWhatsAppMessage(cleanPhone, 
                  `‚úÖ *Factura enviada correctamente*\n\n` +
                  `Tu factura ha sido enviada a ${selectedIntegration.name} exitosamente.`
                );
              } else {
                await sendWhatsAppMessage(cleanPhone, 
                  `‚ùå *Error al enviar factura*\n\n` +
                  `Hubo un problema al enviar tu factura a ${selectedIntegration.name}. Int√©ntalo m√°s tarde.`
                );
              }
            } catch (error) {
              await sendWhatsAppMessage(cleanPhone, 
                `‚ùå *Error al enviar factura*\n\n` +
                `Hubo un problema al enviar tu factura a ${selectedIntegration.name}. Int√©ntalo m√°s tarde.`
              );
            }
          } else {
            await sendWhatsAppMessage(cleanPhone, 
              `‚ùå *No hay facturas recientes*\n\n` +
              `Env√≠a una imagen de tu factura primero para poder procesarla.`
            );
          }
        } else {
          await sendWhatsAppMessage(cleanPhone, 
            `‚ùå *Opci√≥n inv√°lida*\n\nResponde con un n√∫mero del 1 al ${integrations.length}`
          );
        }
      } else {
        await sendWhatsAppMessage(cleanPhone, 
          `‚ùì *Comando no reconocido*\n\nEscribe "ayuda" para ver los comandos disponibles.`
        );
      }
  }
}

export async function GET(request: NextRequest) {
  // Verificaci√≥n de webhook para WhatsApp Business API
  const { searchParams } = new URL(request.url);
  const mode = searchParams.get('hub.mode');
  const token = searchParams.get('hub.verify_token');
  const challenge = searchParams.get('hub.challenge');

  if (mode === 'subscribe' && token === process.env.WHATSAPP_WEBHOOK_VERIFY_TOKEN) {
    return new NextResponse(challenge, { status: 200 });
  }

  return new NextResponse('Forbidden', { status: 403 });
}

export async function POST(request: NextRequest) {
  try {
    const contentType = request.headers.get('content-type');
    
    if (contentType?.includes('application/json')) {
      // WhatsApp Business API
      const body: WhatsAppBusinessWebhook = await request.json();
      
      if (body.object === 'whatsapp_business_account') {
        for (const entry of body.entry) {
          for (const change of entry.changes) {
            if (change.value.messages) {
              for (const message of change.value.messages) {
                const phoneNumber = message.from;
                
                if (message.type === 'text' && message.text) {
                  await handleTextCommand(phoneNumber, message.text.body);
                } else if (message.type === 'image' && message.image) {
                  console.log('üñºÔ∏è Procesando imagen de:', phoneNumber);
                  
                  try {
                    // Verificar usuario
                    console.log('üîç Verificando usuario...');
                    const userStatus = await checkUserSubscription(phoneNumber);
                    
                    if (!userStatus.isSubscribed || !userStatus.quotaAvailable) {
                      console.log('‚ùå Usuario sin suscripci√≥n o cuota');
                      await sendWhatsAppMessage(phoneNumber, 
                        `‚ùå *Suscripci√≥n inactiva o sin cuota*\n\nVe a tu dashboard para activar tu plan.`
                      );
                      continue;
                    }
                    
                    console.log('‚úÖ Usuario verificado, procesando imagen...');
                    
                    // Obtener URL del archivo
                    console.log('üì• Obteniendo URL del archivo con ID:', message.image.id);
                    const mediaResponse = await fetch(
                      `https://graph.facebook.com/v18.0/${message.image.id}`,
                      {
                        headers: {
                          'Authorization': `Bearer ${process.env.WHATSAPP_BUSINESS_TOKEN}`
                        }
                      }
                    );
                    
                    const mediaData = await mediaResponse.json();
                    console.log('üîó Respuesta de Facebook API:', mediaData);
                    
                    if (!mediaData.url) {
                      console.log('‚ùå No se encontr√≥ URL del archivo');
                      throw new Error('No media URL found');
                    }
                    
                    console.log('‚¨áÔ∏è Descargando archivo desde:', mediaData.url);
                    const mediaBuffer = await downloadMedia(mediaData.url);
                    console.log('‚úÖ Archivo descargado, tama√±o:', mediaBuffer.length, 'bytes');
                    
                    // Procesar recibo
                    console.log('üîÑ Procesando recibo...');
                    const result = await processReceipt(phoneNumber, mediaBuffer, message.image.mime_type);
                    console.log('üìä Resultado del procesamiento:', result);
                    
                    console.log('‚úÖ Recibo procesado exitosamente');
                    
                    // Obtener integraciones y enviar men√∫
                    console.log('üîç Obteniendo integraciones...');
                    const integrations = await getUserIntegrations(phoneNumber);
                    console.log('üîó Integraciones encontradas:', integrations.length);
                    
                    console.log('üìã Generando men√∫...');
                    const menu = generateIntegrationsMenu(integrations, phoneNumber);
                    console.log('üì§ Enviando men√∫ al usuario...');
                    
                    await sendWhatsAppMessage(phoneNumber, menu.message);
                    console.log('‚úÖ Men√∫ enviado correctamente');
                  } catch (error) {
                    console.error('‚ùå Error completo en procesamiento de imagen:', error);
                    await sendWhatsAppMessage(phoneNumber, 
                      `‚ùå *Error al procesar factura*\n\nHubo un problema procesando tu factura. Int√©ntalo nuevamente.`
                    );
                  }
                }
              }
            }
          }
        }
      }
    } else {
      // Twilio webhook (para testing)
      const formData = await request.formData();
      const message: WhatsAppMessage = {
        From: formData.get('From') as string,
        To: formData.get('To') as string,
        Body: formData.get('Body') as string || '',
        MediaUrl0: formData.get('MediaUrl0') as string || '',
        MediaContentType0: formData.get('MediaContentType0') as string || '',
        NumMedia: formData.get('NumMedia') as string || '0'
      };
      
      const phoneNumber = cleanPhoneNumber(message.From);
      const hasMedia = parseInt(message.NumMedia) > 0;
      
      if (hasMedia && message.MediaUrl0) {
        // Verificar usuario
        const userStatus = await checkUserSubscription(phoneNumber);
        
        if (!userStatus.isSubscribed || !userStatus.quotaAvailable) {
          await sendWhatsAppMessage(phoneNumber, 
            `‚ùå *Suscripci√≥n inactiva o sin cuota*\n\nVe a tu dashboard para activar tu plan.`
          );
          return NextResponse.json({ status: 'error', message: 'User not authorized' });
        }
        
        // Verificar que el archivo multimedia existe
        if (!message.MediaUrl0 || !message.MediaContentType0) {
          await sendWhatsAppMessage(phoneNumber, 
            `‚ùå *Error al procesar archivo*\n\nNo se pudo obtener la informaci√≥n del archivo multimedia.`
          );
          return NextResponse.json({ status: 'error', message: 'No media URL or content type' });
        }
        
        // Descargar archivo
        const mediaBuffer = await downloadMedia(message.MediaUrl0);
        
        // Procesar recibo
        try {
          const result = await processReceipt(phoneNumber, mediaBuffer, message.MediaContentType0);
          
          if (result.success) {
            // Obtener integraciones y enviar men√∫
            const integrations = await getUserIntegrations(phoneNumber);
            const menu = generateIntegrationsMenu(integrations, phoneNumber);
            await sendWhatsAppMessage(phoneNumber, menu.message);
          } else {
            await sendWhatsAppMessage(phoneNumber, 
              `‚ùå *Error al procesar factura*\n\nHubo un problema procesando tu factura. Int√©ntalo nuevamente.`
            );
          }
        } catch (error) {
          await sendWhatsAppMessage(phoneNumber, 
            `‚ùå *Error al procesar factura*\n\nHubo un problema procesando tu factura. Int√©ntalo nuevamente.`
          );
        }
      } else if (message.Body) {
        // Manejar comando de texto
        await handleTextCommand(message.From, message.Body);
      }
    }
    
    return NextResponse.json({ status: 'success' });
  } catch (error) {
    return NextResponse.json({ 
      status: 'error', 
      message: 'Internal server error' 
    }, { status: 500 });
  }
} 